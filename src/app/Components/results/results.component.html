<div class="results-container">
  <div class="section-header">
    <h3>Results</h3>
    <p>Resultados de medición y métodos utilizados en la calibración</p>
  </div>

  <!-- Measurement Result Block EDITABLE -->
  <div class="data-block">
    <div class="block-header">
      <h4>Measurement Result</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditingMeasurementResult"
          class="edit-btn"
          (click)="toggleEditMeasurementResult()"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>
        <ng-container *ngIf="isEditingMeasurementResult">
          <button class="save-btn" (click)="saveMeasurementResultName()">
            <i class="material-icons">save</i>
            Guardar
          </button>
          <button class="cancel-btn" (click)="toggleEditMeasurementResult()">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </ng-container>
      </div>
    </div>
    <div class="block-content">
      <!-- View Mode -->
      <div class="measurement-result-view" *ngIf="!isEditingMeasurementResult">
        <table class="data-table">
          <tr>
            <td class="label">Name:</td>
            <td>{{ measurementResultName || "No definido" }}</td>
          </tr>
        </table>
      </div>

      <!-- Edit Mode -->
      <div class="measurement-result-edit" *ngIf="isEditingMeasurementResult">
        <div class="form-group">
          <label>Name:</label>
          <input
            type="text"
            [(ngModel)]="measurementResultName"
            placeholder="Ingrese el nombre del resultado de medición"
            class="form-control"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Used Methods Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Used Methods</h4>
      <!-- Botones de agregar/editar pueden quedarse si quieres edición local -->
    </div>
    <div class="block-content">
      <!-- View Mode -->
      <div class="methods-view">
        <div class="item-card" *ngFor="let method of usedMethods">
          <div class="item-header">
            <h5>{{ method.name || "Sin nombre" }}</h5>
          </div>
          <div class="item-details">
            <div class="detail-row" *ngIf="method.description">
              <strong>Description:</strong> {{ method.description }}
            </div>
            <div class="detail-row" *ngIf="method.norm">
              <strong>Norm:</strong> {{ method.norm }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Influence Conditions Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Influence Conditions</h4>
      <div class="block-actions">
        <button
          class="edit-btn"
          (click)="toggleEdit('influence-conditions')"
          [class.active]="isEditing('influence-conditions')"
        >
          <i class="material-icons">{{
            isEditing("influence-conditions") ? "close" : "edit"
          }}</i>
          {{ isEditing("influence-conditions") ? "Cancelar" : "Editar" }}
        </button>
      </div>
    </div>

    <div class="block-content">
      <!-- View Mode -->
      <div *ngIf="!isEditing('influence-conditions')" class="conditions-view">
        <div class="item-card" *ngFor="let condition of influenceConditions">
          <div class="item-header">
            <h5>{{ condition.name || "Sin nombre" }}</h5>
          </div>
          <div class="sub-block">
            <h6>Sub-block Data:</h6>
            <div class="sub-block-details">
              <div class="detail-row">
                <strong>Name:</strong> {{ condition.subBlock.name }}
              </div>
              <div class="detail-row">
                <strong>Value:</strong> {{ condition.subBlock.value }}
              </div>
              <div class="detail-row">
                <strong>Unit:</strong> {{ condition.subBlock.unit }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditing('influence-conditions')" class="conditions-edit">
        <div class="edit-form">
          <div
            class="item-form"
            *ngFor="let condition of influenceConditions; let i = index"
          >
            <div class="item-form-header">
              <h5>{{ condition.name }}</h5>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>Name:</label>
                <input
                  type="text"
                  [(ngModel)]="condition.name"
                  readonly
                  class="readonly-field"
                />
              </div>
              <div class="form-group">
                <label>RefType:</label>
                <input
                  type="text"
                  [(ngModel)]="condition.refType"
                  readonly
                  class="readonly-field"
                />
              </div>
            </div>
            <div class="identifications-section">
              <h6>Sub-block Data:</h6>
              <div class="form-grid">
                <div class="form-group">
                  <label>Quantity Name:</label>
                  <input
                    type="text"
                    [(ngModel)]="condition.subBlock.name"
                    placeholder="Ingrese el nombre de la cantidad"
                    readonly
                    class="readonly-field"
                  />
                </div>
                <div class="form-group">
                  <label>Quantity Value:</label>
                  <input
                    type="text"
                    [(ngModel)]="condition.subBlock.value"
                    placeholder="Ingrese el valor"
                  />
                </div>
                <div class="form-group">
                  <label>Quantity Unit:</label>
                  <input
                    type="text"
                    [(ngModel)]="condition.subBlock.unit"
                    readonly
                    class="readonly-field"
                  />
                </div>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button
              class="save-btn"
              (click)="saveBlock('influence-conditions')"
            >
              Guardar
            </button>
            <button
              class="cancel-btn"
              (click)="cancelEdit('influence-conditions')"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Measuring Equipments Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Measuring Equipments</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditingMeasuringEquipments"
          class="edit-btn"
          (click)="toggleEditMeasuringEquipments()"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>
        <ng-container *ngIf="isEditingMeasuringEquipments">
          <button class="save-btn" (click)="saveMeasuringEquipments()">
            <i class="material-icons">save</i>
            Guardar
          </button>
          <button class="cancel-btn" (click)="cancelEditMeasuringEquipments()">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </ng-container>
      </div>
    </div>

    <div class="block-content">
      <!-- Edit Mode -->
      <div *ngIf="isEditingMeasuringEquipments" class="equipments-edit">
        <div class="form-group">
          <label>Seleccionar Patrones ({{ coreData.pt_id || "PT" }}):</label>
          <ng-multiselect-dropdown
            [placeholder]="'Seleccione los patrones'"
            [settings]="patronDropdownSettings"
            [data]="availablePatrones"
            [(ngModel)]="selectedPatrones"
            (onSelect)="onPatronSelect($event)"
            (onDeSelect)="onPatronDeSelect($event)"
          >
          </ng-multiselect-dropdown>
        </div>

        <!-- Equipos encontrados desde los patrones -->
        <div
          class="equipments-preview"
          *ngIf="equipmentsFromPatrones.length > 0"
        >
          <h5>Equipos encontrados ({{ equipmentsFromPatrones.length }}):</h5>
          <div class="equipment-preview-list">
            <div
              class="equipment-preview-card"
              *ngFor="let eq of equipmentsFromPatrones"
            >
              <div class="equipment-preview-header">
                <span class="equipment-preview-name">{{
                  eq.name || "Sin nombre"
                }}</span>
                <span class="equipment-preview-badge">Reference Standard</span>
              </div>
              <div class="equipment-preview-details">
                <div class="preview-row">
                  <span class="preview-label">Manufacturer:</span>
                  <span class="preview-value">{{
                    eq.manufacturer || "N/A"
                  }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Model:</span>
                  <span class="preview-value">{{ eq.model || "N/A" }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Asset ID:</span>
                  <span class="preview-value asset-id">{{ eq.assetId }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Serial Number:</span>
                  <span class="preview-value">{{
                    eq.serialNumber || "N/A"
                  }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Calibration Interval:</span>
                  <span class="preview-value"
                    >{{ eq.calibrationInterval }} months</span
                  >
                </div>
                <div class="preview-row patron-info">
                  <span class="preview-label">Patrón:</span>
                  <span class="preview-value">{{ eq.patronName }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="no-equipments"
          *ngIf="
            selectedPatrones.length > 0 && equipmentsFromPatrones.length === 0
          "
        >
          <p>Cargando equipos...</p>
        </div>
      </div>

      <!-- View Mode -->
      <div *ngIf="!isEditingMeasuringEquipments" class="equipments-view">
        <div
          *ngFor="let equipment of measuringEquipments"
          class="equipment-card"
        >
          <div class="equipment-header">
            <div class="equipment-title">
              <h5>{{ equipment.name }}</h5>
              <span class="equipment-type">
                {{
                  equipment.refType === "basic_standardUsed"
                    ? "Reference Standard"
                    : "Auxiliary Equipment"
                }}
              </span>
            </div>
          </div>

          <div class="equipment-details">
            <div class="detail-row">
              <span class="detail-label"> Manufacturer: </span>
              <span class="detail-value">{{
                equipment.manufacturer || "No definido"
              }}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label"> Model: </span>
              <span class="detail-value">{{
                equipment.model || "No definido"
              }}</span>
            </div>

            <!-- Identifications -->
            <div
              *ngIf="equipment.identifications?.length > 0"
              class="identifications-section"
            >
              <div class="section-title">Identifications</div>
              <div class="identifications-list">
                <div
                  *ngFor="let id of equipment.identifications"
                  class="identification-item"
                >
                  <div class="identification-name">
                    {{ id.name }}
                  </div>
                  <div class="identification-value">{{ id.value }}</div>
                  <div class="identification-issuer">
                    <span class="issuer-badge">
                      {{
                        id.issuer === "manufacturer"
                          ? "Manufacturer"
                          : id.issuer === "Laboratory"
                          ? "Laboratory"
                          : id.issuer
                      }}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div
              *ngIf="!equipment.identifications?.length"
              class="no-identifications"
            >
              Sin identificaciones registradas
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!measuringEquipments?.length" class="empty-state">
          <p>No hay equipos de medición registrados en la base de datos.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- SF PT-XX Block: solo visible si NO se cargó XML -->
  <div class="data-block" *ngIf="operationMode !== 'xml'">
    <ng-container [ngSwitch]="coreData.pt_id">
      <div *ngSwitchCase="'PT-23'">
        <app-pt23-results
          #pt23ResultsComponent
          (resultsGenerated)="refreshResultsFromDB()"
        ></app-pt23-results>
      </div>
      <div *ngSwitchCase="'PT-24'">
        <app-pt23-results
          #pt23ResultsComponent
          (resultsGenerated)="refreshResultsFromDB()"
        ></app-pt23-results>
      </div>
      <div *ngSwitchDefault>
        <p>Seleccione un PT válido para mostrar los cálculos.</p>
      </div>
    </ng-container>
  </div>

  <!-- Results Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Results</h4>
      <div class="block-actions">
        <button
          *ngIf="!editingMeasurementUncertainty"
          class="edit-btn"
          (click)="showMeasurementUncertaintyEditor()"
        >
          <i class="material-icons">edit</i>
          Editar Incertidumbres
        </button>
        <ng-container *ngIf="editingMeasurementUncertainty">
          <button class="save-btn" (click)="saveMeasurementUncertaintyEditor()">
            <i class="material-icons">save</i>
            Guardar
          </button>
          <button
            class="cancel-btn"
            (click)="editingMeasurementUncertainty = false"
          >
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </ng-container>
      </div>
    </div>
    <div class="block-content">
      <!-- Edit Mode - SOLO MUESTRA INCERTIDUMBRE DE VOLTAGE ERROR -->
      <div *ngIf="editingMeasurementUncertainty" class="results-edit">
        <div *ngFor="let result of results">
          <div *ngFor="let qty of result.data">
            <!-- Editar incertidumbre de Voltage Error -->
            <div
              *ngIf="
                qty.name == 'Voltage Error' &&
                qty.measurementUncertainty &&
                qty.measurementUncertainty.expandedMU
              "
              class="form-group"
            >
              <h5>{{ result.name }}</h5>
              <label>{{ qty.name }}</label>
              <input
                type="text"
                [(ngModel)]="
                  qty.measurementUncertainty.expandedMU.valueExpandedMUXMLList
                "
                (ngModelChange)="dccDataService.updateResults(results)"
                placeholder="Valor de incertidumbre expandida"
              />
              <input
                type="text"
                [(ngModel)]="
                  qty.measurementUncertainty.expandedMU.coverageFactorXMLList
                "
                (ngModelChange)="dccDataService.updateResults(results)"
                placeholder="Factor de cobertura"
              />
              <input
                type="text"
                [(ngModel)]="
                  qty.measurementUncertainty.expandedMU
                    .coverageProbabilityXMLList
                "
                (ngModelChange)="dccDataService.updateResults(results)"
                placeholder="Probabilidad de cobertura"
              />
            </div>
            <!-- Editar valor de Mean Value of Scale Factor Obtained -->
            <div
              *ngIf="qty.name == 'Mean Value of Scale Factor Obtained'"
              class="form-group"
            >
              <h5>{{ result.name }}</h5>
              <label>{{ qty.name }}</label>
              <input
                type="text"
                [(ngModel)]="qty.value"
                placeholder="Valor obtenido de Scale Factor"
              />
            </div>
            <!-- Editar valor de Linearity of Scale Factor -->
            <div
              *ngIf="qty.name == 'Linearity of Scale Factor'"
              class="form-group"
            >
              <h5>{{ result.name }}</h5>
              <label>{{ qty.name }}</label>
              <input
                type="text"
                [(ngModel)]="qty.value"
                placeholder="Valor de Linearity"
              />
            </div>
            <!-- Editar valor de Linearity of Scale Factor (voltage dependence) obtained -->
            <div
              *ngIf="
                qty.name ==
                'Linearity of Scale Factor (voltage dependence) obtained'
              "
              class="form-group"
            >
              <h5>{{ result.name }}</h5>
              <label>{{ qty.name }}</label>
              <input
                type="text"
                [(ngModel)]="qty.value"
                placeholder="Valor de Linearity (voltage dependence)"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- View Mode - MOSTRAR TODO COMO ANTES -->
      <div *ngIf="!editingMeasurementUncertainty" class="results-view">
        {{ logResults() }}
        <div class="item-card" *ngFor="let result of results">
          <div class="item-header">
            <h5>{{ result.name || "Sin nombre" }}</h5>
            <span class="ref-type-badge">{{ result.refType }}</span>
          </div>

          <div class="result-data-section">
            <h6>Data Quantities:</h6>
            <div class="quantities-grid">
              <div class="quantity-item" *ngFor="let data of result.data">
                <div class="quantity-header">
                  <strong>{{ data.name || data.refType }}</strong>
                </div>
                <div class="quantity-content">
                  <!-- Mostrar lista si existe valueXMLList -->
                  <div
                    *ngIf="data.valueXMLList !== undefined"
                    class="list-data"
                  >
                    <div class="list-values">
                      <strong>Valores:</strong>
                      {{ data.valueXMLList || data.value }}
                    </div>
                    <div class="list-unit">
                      <strong>Unidad:</strong>
                      {{ data.unitXMLList || data.unit }}
                    </div>
                    <!-- Incertidumbre solo para Voltage Error -->
                    <div
                      class="measurement-uncertainty-display"
                      *ngIf="
                        data.name === 'Voltage Error' &&
                        data.measurementUncertainty?.expandedMU
                          ?.valueExpandedMUXMLList &&
                        data.measurementUncertainty.expandedMU.valueExpandedMUXMLList.trim() !==
                          ''
                      "
                    >
                      <h6>Measurement Uncertainty</h6>
                      <div class="uncertainty-values">
                        <div class="uncertainty-row">
                          <span class="uncertainty-label"
                            >Expanded Uncertainty Values:</span
                          >
                          <span class="uncertainty-value">
                            {{ getMeasurementUncertainty(data) }}
                          </span>
                        </div>
                        <div class="uncertainty-row">
                          <span class="uncertainty-label"
                            >Coverage Factor:</span
                          >
                          <span class="uncertainty-value">
                            {{
                              data.measurementUncertainty.expandedMU
                                .coverageFactorXMLList
                            }}
                          </span>
                        </div>
                        <div class="uncertainty-row">
                          <span class="uncertainty-label"
                            >Coverage Probability:</span
                          >
                          <span class="uncertainty-value">
                            {{
                              data.measurementUncertainty.expandedMU
                                .coverageProbabilityXMLList
                            }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Mostrar valor simple si NO tiene valueXMLList (Mean Scale Factor, Linearity) -->
                  <div
                    *ngIf="
                      data.valueXMLList === undefined &&
                      (data.value !== undefined || data.unit !== undefined)
                    "
                    class="simple-data"
                  >
                    <div class="simple-value">
                      <strong>Valor:</strong>
                      {{ data.value || "N/A" }}
                    </div>
                    <div class="simple-unit">
                      <strong>Unidad:</strong>
                      {{ data.unit || "N/A" }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
