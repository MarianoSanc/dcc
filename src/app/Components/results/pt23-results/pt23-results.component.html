<div class="pt23-results-container">
  <div class="section-header">
    <div class="header-content">
      <div>
        <h3>PT-23 Results</h3>
        <p>Resultados de calibración PT-23 (Auto-generación activada)</p>
      </div>
      <div class="header-actions">
        <button
          *ngIf="!isEditing && numeroScaleFactor > 0"
          class="generate-results-btn"
          (click)="generarYActualizarResultados()"
          title="Regenerar resultados manualmente con los datos actuales"
        >
          <i class="material-icons">refresh</i>
          Regenerar Resultados
        </button>
        <button *ngIf="!isEditing" class="edit-btn" (click)="toggleEdit()">
          <i class="material-icons">edit</i>
          Editar
        </button>
        <ng-container *ngIf="isEditing">
          <button class="save-btn" (click)="guardarScaleFactor()">
            <i class="material-icons">save</i>
            Guardar
          </button>
          <button class="cancel-btn" (click)="cancelarEdicion()">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Parámetros de referencia SFx y SFref -->
  <div class="parameters-section">
    <div class="parameters-card">
      <div class="card-header-params">
        <div class="header-text">
          <h4>Parámetros de Referencia</h4>
        </div>
      </div>

      <div class="parameters-grid">
        <div class="parameter-group">
          <label class="parameter-label">
            <i class="material-icons">insights</i>
            SFx (Scale Factor X)
          </label>
          <div class="parameter-input-wrapper">
            <input
              type="number"
              [(ngModel)]="sfx"
              placeholder="Ingrese SFx"
              class="parameter-input"
              [disabled]="!isEditing"
              step="0.000001"
            />
            <span class="parameter-hint">Valor de referencia X</span>
          </div>
        </div>

        <div class="parameter-group">
          <label class="parameter-label">
            <i class="material-icons">straighten</i>
            SFref (Scale Factor Reference)
          </label>
          <div class="parameter-input-wrapper">
            <input
              type="number"
              [(ngModel)]="sfref"
              placeholder="Ingrese SFref"
              class="parameter-input"
              [disabled]="!isEditing"
              step="0.000001"
            />
            <span class="parameter-hint">Valor de referencia</span>
          </div>
        </div>
      </div>

      <div class="parameters-warning" *ngIf="isEditing && (!sfx || !sfref)">
        <i class="material-icons">warning</i>
        <span>Se requieren ambos valores (SFx y SFref) para guardar</span>
      </div>
    </div>
  </div>

  <!-- Configuración de pruebas -->
  <div class="config-section">
    <!-- Scale Factor Config -->
    <div class="config-card">
      <div class="card-icon scale-factor-icon">
        <i class="material-icons">straighten</i>
      </div>
      <div class="card-content">
        <label class="card-label">Scale Factor (SF)</label>
        <p class="card-description">Número de pruebas de Scale Factor</p>
        <div class="options-selector">
          <div
            *ngFor="let opcion of opcionesScaleFactor"
            class="option-box"
            [class.selected]="numeroScaleFactor === opcion"
            [class.disabled]="!isEditing"
            (click)="
              isEditing &&
                (numeroScaleFactor = opcion) &&
                onNumeroScaleFactorChange()
            "
          >
            <span class="option-number">{{ opcion }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Linearity Test Config -->
    <div class="config-card">
      <div class="card-icon linearity-icon">
        <i class="material-icons">show_chart</i>
      </div>
      <div class="card-content">
        <label class="card-label">Linearity Test (LT)</label>
        <p class="card-description">Número de pruebas de Linearity Test</p>
        <div class="options-selector">
          <div
            *ngFor="let opcion of opcionesLinearityTest"
            class="option-box"
            [class.selected]="numeroLinearityTest === opcion"
            [class.disabled]="!isEditing"
            (click)="
              isEditing &&
                (numeroLinearityTest = opcion) &&
                onNumeroLinearityTestChange()
            "
          >
            <span class="option-number">{{ opcion }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stability Test Config -->
    <div class="config-card">
      <div class="card-icon stability-icon">
        <i class="material-icons">timeline</i>
      </div>
      <div class="card-content">
        <label class="card-label">Short-term Stability Test (ST)</label>
        <p class="card-description">Número de pruebas de Stability Test</p>
        <div class="options-selector">
          <div
            *ngFor="let opcion of opcionesStabilityTest"
            class="option-box"
            [class.selected]="numeroStabilityTest === opcion"
            [class.disabled]="!isEditing"
            (click)="
              isEditing &&
                (numeroStabilityTest = opcion) &&
                onNumeroStabilityTestChange()
            "
          >
            <span class="option-number">{{ opcion }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scale Factor Sections -->
  <div *ngIf="numeroScaleFactor === 0" class="info-message">
    <i class="material-icons">info</i>
    <p>No se han configurado pruebas de Scale Factor</p>
  </div>

  <div
    *ngFor="let sf of scaleFactorData; let sfIndex = index"
    class="test-section"
  >
    <div class="test-header scale-factor-header">
      <div class="test-title">
        <i class="material-icons">straighten</i>
        <h3>Scale Factor {{ numeroScaleFactor > 1 ? sfIndex + 1 : "" }}</h3>
        <span class="test-badge sf-badge"
          >SF{{ numeroScaleFactor > 1 ? sfIndex + 1 : "" }}</span
        >
      </div>
      <button
        *ngIf="isEditing"
        class="add-nivel-btn"
        (click)="agregarNivel(sfIndex)"
      >
        <i class="material-icons">add</i>
        Agregar Nivel
      </button>
    </div>

    <div class="test-content">
      <!-- Tablas en grid horizontal -->
      <div class="tables-grid">
        <div
          class="tabla-nivel-vertical"
          *ngFor="let tabla of sf.tablas; let tablaIndex = index"
        >
          <div class="tabla-header-vertical">
            <div class="nivel-info">
              <h4>Nivel {{ tablaIndex + 1 }}</h4>
              <div class="nivel-input-wrapper">
                <input
                  type="number"
                  [(ngModel)]="tabla.nivel"
                  placeholder="kV"
                  class="nivel-input-compact"
                  [disabled]="!isEditing"
                  step="0.001"
                />
                <span class="unit-label">kV</span>
              </div>
            </div>
            <button
              *ngIf="isEditing && sf.tablas.length > 1"
              class="delete-nivel-btn-compact"
              (click)="eliminarNivel(sfIndex, tablaIndex)"
              title="Eliminar nivel"
            >
              <i class="material-icons">delete</i>
            </button>
          </div>

          <div class="table-vertical-wrapper">
            <table class="results-table-vertical">
              <thead>
                <tr>
                  <th class="row-number-header">#</th>
                  <th class="dut-header-vertical">
                    <div class="header-with-actions">
                      <span>DUT (kV)</span>
                      <div *ngIf="isEditing" class="column-actions">
                        <button
                          class="paste-btn"
                          (click)="pegarValores(sfIndex, tablaIndex, 'dut')"
                          title="Pegar valores desde portapapeles"
                        >
                          <i class="material-icons">content_paste</i>
                        </button>
                        <button
                          class="clear-btn"
                          (click)="limpiarColumna(sfIndex, tablaIndex, 'dut')"
                          title="Limpiar columna"
                        >
                          <i class="material-icons">clear_all</i>
                        </button>
                      </div>
                    </div>
                  </th>
                  <th class="patron-header-vertical">
                    <div class="header-with-actions">
                      <span>Patrón (kV)</span>
                      <div *ngIf="isEditing" class="column-actions">
                        <button
                          class="paste-btn"
                          (click)="pegarValores(sfIndex, tablaIndex, 'patron')"
                          title="Pegar valores desde portapapeles"
                        >
                          <i class="material-icons">content_paste</i>
                        </button>
                        <button
                          class="clear-btn"
                          (click)="
                            limpiarColumna(sfIndex, tablaIndex, 'patron')
                          "
                          title="Limpiar columna"
                        >
                          <i class="material-icons">clear_all</i>
                        </button>
                      </div>
                    </div>
                  </th>
                  <!-- NUEVAS COLUMNAS CALCULADAS -->
                  <th class="error-header-vertical">
                    <span>Error (%)</span>
                  </th>
                  <th class="sf-corrected-header-vertical">
                    <span>SF Corrected</span>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let fila of filas; let i = index">
                  <td class="row-number">{{ i + 1 }}</td>
                  <td class="data-cell-vertical">
                    <input
                      type="number"
                      [(ngModel)]="tabla.dut[i]"
                      placeholder="---"
                      class="data-input-vertical"
                      [disabled]="!isEditing"
                      step="0.001"
                    />
                  </td>
                  <td class="data-cell-vertical">
                    <input
                      type="number"
                      [(ngModel)]="tabla.patron[i]"
                      placeholder="---"
                      class="data-input-vertical"
                      [disabled]="!isEditing"
                      step="0.001"
                    />
                  </td>
                  <!-- NUEVAS CELDAS CALCULADAS -->
                  <td class="calculated-cell error-cell">
                    <span
                      class="calculated-value"
                      *ngIf="getErrorForRow(tabla.dut[i], tabla.patron[i])"
                    >
                      {{ getErrorForRow(tabla.dut[i], tabla.patron[i]) }}
                      <span class="unit">%</span>
                    </span>
                    <span
                      class="empty-indicator"
                      *ngIf="!getErrorForRow(tabla.dut[i], tabla.patron[i])"
                      >-</span
                    >
                  </td>
                  <td class="calculated-cell sf-cell">
                    <span
                      class="calculated-value"
                      *ngIf="
                        getSFCorrectedForRow(tabla.dut[i], tabla.patron[i])
                      "
                    >
                      {{ getSFCorrectedForRow(tabla.dut[i], tabla.patron[i]) }}
                    </span>
                    <span
                      class="empty-indicator"
                      *ngIf="
                        !getSFCorrectedForRow(tabla.dut[i], tabla.patron[i])
                      "
                      >-</span
                    >
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="average-row-vertical">
                  <td class="average-label-vertical">
                    <i class="material-icons">functions</i>
                  </td>
                  <td class="average-cell-vertical dut-average">
                    {{ getAverage(tabla.dut) }}
                  </td>
                  <td class="average-cell-vertical patron-average">
                    {{ getAverage(tabla.patron) }}
                  </td>
                  <!-- NUEVAS CELDAS DE PROMEDIO -->
                  <td class="average-cell-vertical error-average">
                    <strong>{{
                      getError(tabla.dut, tabla.patron) || "N/A"
                    }}</strong>
                  </td>
                  <td class="average-cell-vertical sf-average">
                    <strong>{{
                      getObtainedScaleFactor(tabla.dut, tabla.patron) || "N/A"
                    }}</strong>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- ELIMINAR ESTAS COLUMNAS ANTIGUAS -->
          <!-- 
          <div class="table-column average-column">
            <div class="column-header">
              <h6>Error (%)</h6>
            </div>
            <div class="average-value">
              <strong>{{ getError(tabla.dut, tabla.patron) || "N/A" }}</strong>
            </div>
          </div>

          <div class="table-column average-column">
            <div class="column-header">
              <h6>SF Corrected</h6>
            </div>
            <div class="average-value">
              <strong>{{
                getObtainedScaleFactor(tabla.dut, tabla.patron) || "N/A"
              }}</strong>
            </div>
          </div>
          -->
        </div>
      </div>

      <div
        *ngIf="!sf.tablas || sf.tablas.length === 0"
        class="empty-state-small"
      >
        <i class="material-icons">assessment</i>
        <p>No hay datos de Scale Factor disponibles.</p>
      </div>
    </div>
  </div>

  <!-- Linearity Test Sections -->
  <div
    *ngFor="let lt of [].constructor(numeroLinearityTest); let ltIndex = index"
    class="test-section"
  >
    <div class="test-header linearity-header">
      <div class="test-title">
        <i class="material-icons">show_chart</i>
        <h3>Linearity Test {{ numeroLinearityTest > 1 ? ltIndex + 1 : "" }}</h3>
        <span class="test-badge lt-badge"
          >LT{{ numeroLinearityTest > 1 ? ltIndex + 1 : "" }}</span
        >
      </div>
    </div>

    <div class="test-content">
      <div class="placeholder-content">
        <i class="material-icons">construction</i>
        <p>Linearity Test - Próximamente</p>
      </div>
    </div>
  </div>

  <!-- Empty state cuando no hay Linearity Test -->
  <div *ngIf="numeroLinearityTest === 0" class="info-message">
    <i class="material-icons">info</i>
    <p>No se han configurado pruebas de Linearity Test</p>
  </div>

  <!-- Stability Test Sections -->
  <div
    *ngFor="let st of [].constructor(numeroStabilityTest); let stIndex = index"
    class="test-section"
  >
    <div class="test-header stability-header">
      <div class="test-title">
        <i class="material-icons">timeline</i>
        <h3>
          Short-term Stability Test
          {{ numeroStabilityTest > 1 ? stIndex + 1 : "" }}
        </h3>
        <span class="test-badge st-badge"
          >ST{{ numeroStabilityTest > 1 ? stIndex + 1 : "" }}</span
        >
      </div>
    </div>

    <div class="test-content">
      <div class="placeholder-content">
        <i class="material-icons">construction</i>
        <p>Short-term Stability Test - Próximamente</p>
      </div>
    </div>
  </div>

  <!-- Empty state cuando no hay Stability Test -->
  <div *ngIf="numeroStabilityTest === 0" class="info-message">
    <i class="material-icons">info</i>
    <p>No se han configurado pruebas de Short-term Stability Test</p>
  </div>
</div>
