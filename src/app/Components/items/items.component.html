<div class="items-container">
  <div class="section-header">
    <h3>Items & Object Identifications</h3>
  </div>

  <!-- Main Item Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Main Item (Object)</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditing('mainItem')"
          class="edit-btn"
          (click)="toggleEdit('mainItem')"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>
        <button
          *ngIf="isEditing('mainItem')"
          class="cancel-btn"
          (click)="cancelEdit('mainItem')"
        >
          <i class="material-icons">close</i>
          Cancelar
        </button>
      </div>
    </div>

    <div class="block-content">
      <!-- Vista solo lectura del item principal -->
      <div *ngIf="!isEditing('mainItem')" class="main-item-view">
        <table class="data-table">
          <tr *ngIf="mainItem.name">
            <td class="label">Name (Object):</td>
            <td>{{ mainItem.name }}</td>
          </tr>
          <tr *ngIf="mainItem.model">
            <td class="label">Model:</td>
            <td>{{ mainItem.model }}</td>
          </tr>
          <tr *ngIf="mainItem.manufacturer">
            <td class="label">Manufacturer:</td>
            <td>{{ mainItem.manufacturer }}</td>
          </tr>
          <tr *ngIf="mainItem.serialNumber">
            <td class="label">Serial Number:</td>
            <td>{{ mainItem.serialNumber }}</td>
          </tr>
          <tr *ngIf="mainItem.customerAssetId">
            <td class="label">Customer's Asset ID:</td>
            <td>{{ mainItem.customerAssetId }}</td>
          </tr>
        </table>
        <div
          *ngIf="
            !mainItem.name &&
            !mainItem.model &&
            !mainItem.manufacturer &&
            !mainItem.serialNumber &&
            !mainItem.customerAssetId
          "
          class="no-data"
        >
          No hay información del item principal
        </div>
      </div>

      <!-- Formulario de edición del item principal -->
      <div *ngIf="isEditing('mainItem')" class="edit-form">
        <div class="main-item-grid">
          <div class="form-group">
            <label>Name (Object):</label>
            <input
              type="text"
              [(ngModel)]="mainItem.name"
              placeholder="Nombre del objeto principal"
            />
          </div>
          <div class="form-group">
            <label>Model:</label>
            <input
              type="text"
              [(ngModel)]="mainItem.model"
              placeholder="Modelo"
            />
          </div>
          <div class="form-group">
            <label>Manufacturer:</label>
            <input
              type="text"
              [(ngModel)]="mainItem.manufacturer"
              placeholder="Fabricante"
            />
          </div>
          <div class="form-group">
            <label>Serial Number:</label>
            <input
              type="text"
              [(ngModel)]="mainItem.serialNumber"
              placeholder="Número de serie"
            />
          </div>
          <div class="form-group">
            <label>Customer's Asset ID:</label>
            <input
              type="text"
              [(ngModel)]="mainItem.customerAssetId"
              placeholder="ID del cliente"
            />
          </div>
        </div>

        <div class="form-actions">
          <button class="save-btn" (click)="saveBlock('mainItem')">
            <i class="material-icons">save</i>
            Guardar Main Item
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Object Identifications Groups Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Object Identifications Groups</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditing('objectGroups')"
          class="edit-btn"
          (click)="toggleEdit('objectGroups')"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>
        <div *ngIf="isEditing('objectGroups')" class="editing-actions">
          <button class="add-btn" (click)="addObjectGroup()">
            <i class="material-icons">add</i>
            Agregar Grupo
          </button>
          <button class="cancel-btn" (click)="cancelEdit('objectGroups')">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div class="block-content">
      <!-- Vista solo lectura de grupos -->
      <div *ngIf="!isEditing('objectGroups')">
        <div *ngIf="hasValidObjectGroups(); else noObjectGroups">
          <div
            class="group-card"
            *ngFor="let group of getValidObjectGroups(); let i = index"
          >
            <h6>{{ group.groupName }}</h6>
            <div class="group-content">
              <!-- Solo mostrar Assigned Measurement Range si tiene algún valor -->
              <div
                class="group-section"
                *ngIf="measurementRangeHasAnyValue(group)"
              >
                <h7>Assigned Measurement Range</h7>
                <table class="data-table group-table">
                  <tr *ngIf="hasValueInMeasurementRange(group, 'label')">
                    <td class="label">Label:</td>
                    <td>{{ group.assignedMeasurementRange.label }}</td>
                  </tr>
                  <tr *ngIf="hasValueInMeasurementRange(group, 'value')">
                    <td class="label">Value:</td>
                    <td>{{ group.assignedMeasurementRange.value }}</td>
                  </tr>
                  <tr *ngIf="hasValueInMeasurementRange(group, 'unit')">
                    <td class="label">Unit:</td>
                    <td>{{ group.assignedMeasurementRange.unit }}</td>
                  </tr>
                </table>
              </div>

              <!-- Solo mostrar Assigned Scale Factor si tiene algún valor -->
              <div class="group-section" *ngIf="scaleFactorHasAnyValue(group)">
                <h7>Assigned Scale Factor</h7>
                <table class="data-table group-table">
                  <tr *ngIf="hasValueInScaleFactor(group, 'label')">
                    <td class="label">Label:</td>
                    <td>{{ group.assignedScaleFactor.label }}</td>
                  </tr>
                  <tr *ngIf="hasValueInScaleFactor(group, 'value')">
                    <td class="label">Value:</td>
                    <td>{{ group.assignedScaleFactor.value }}</td>
                  </tr>
                  <tr *ngIf="hasValueInScaleFactor(group, 'unit')">
                    <td class="label">Unit:</td>
                    <td>{{ group.assignedScaleFactor.unit }}</td>
                  </tr>
                </table>
              </div>

              <!-- Solo mostrar Rated Frequency si tiene algún valor -->
              <div
                class="group-section"
                *ngIf="ratedFrequencyHasAnyValue(group)"
              >
                <h7>Rated Frequency</h7>
                <table class="data-table group-table">
                  <tr *ngIf="hasValueInRatedFrequency(group, 'label')">
                    <td class="label">Label:</td>
                    <td>{{ group.ratedFrequency.label }}</td>
                  </tr>
                  <tr *ngIf="hasValueInRatedFrequency(group, 'value')">
                    <td class="label">Value:</td>
                    <td>{{ group.ratedFrequency.value }}</td>
                  </tr>
                  <tr *ngIf="hasValueInRatedFrequency(group, 'unit')">
                    <td class="label">Unit:</td>
                    <td>{{ group.ratedFrequency.unit }}</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noObjectGroups>
          <p class="no-data">
            No hay grupos de identificaciones de objeto definidos
          </p>
        </ng-template>
      </div>

      <!-- Formulario de edición de grupos -->
      <div *ngIf="isEditing('objectGroups')" class="edit-form">
        <div
          class="group-form"
          *ngFor="let group of objectGroups; let groupIndex = index"
        >
          <div class="group-header">
            <h6>{{ group.groupName }}</h6>
            <button
              class="remove-btn"
              (click)="removeObjectGroup(groupIndex)"
              [disabled]="objectGroups.length <= 1"
              [title]="
                objectGroups.length <= 1
                  ? 'Debe existir al menos un grupo'
                  : 'Eliminar grupo'
              "
            >
              <i class="material-icons">delete</i>
            </button>
          </div>

          <div class="group-fields">
            <div class="form-group">
              <label>Group Name:</label>
              <input
                type="text"
                [(ngModel)]="group.groupName"
                placeholder="Nombre del grupo"
                (ngModelChange)="updateGroupNames()"
              />
            </div>

            <!-- Assigned Measurement Range - Labels y units NO editables -->
            <div class="quantity-section">
              <h7>Assigned Measurement Range</h7>
              <div class="quantity-fields">
                <div class="form-group">
                  <label>Label:</label>
                  <input
                    type="text"
                    [value]="'Rated voltage'"
                    readonly
                    class="readonly-field"
                    title="Este campo no es editable"
                  />
                </div>
                <div class="form-group">
                  <label>Value:</label>
                  <input
                    type="text"
                    [(ngModel)]="group.assignedMeasurementRange.value"
                    placeholder="Valor"
                  />
                </div>
                <div class="form-group">
                  <label>Unit:</label>
                  <input
                    type="text"
                    [value]="'\\volt'"
                    readonly
                    class="readonly-field"
                    title="Este campo no es editable"
                  />
                </div>
              </div>
            </div>

            <!-- Assigned Scale Factor - Labels y units NO editables -->
            <div class="quantity-section">
              <h7>Assigned Scale Factor</h7>
              <div class="quantity-fields">
                <div class="form-group">
                  <label>Label:</label>
                  <input
                    type="text"
                    [value]="'Scale factor'"
                    readonly
                    class="readonly-field"
                    title="Este campo no es editable"
                  />
                </div>
                <div class="form-group">
                  <label>Value:</label>
                  <input
                    type="text"
                    [(ngModel)]="group.assignedScaleFactor.value"
                    placeholder="Valor"
                  />
                </div>
                <div class="form-group">
                  <label>Unit:</label>
                  <input
                    type="text"
                    [value]="'\\one'"
                    readonly
                    class="readonly-field"
                    title="Este campo no es editable"
                  />
                </div>
              </div>
            </div>

            <!-- Rated Frequency - Labels y units NO editables -->
            <div class="quantity-section">
              <h7>Rated Frequency</h7>
              <div class="quantity-fields">
                <div class="form-group">
                  <label>Label:</label>
                  <input
                    type="text"
                    [value]="'Rated Frequency'"
                    readonly
                    class="readonly-field"
                    title="Este campo no es editable"
                  />
                </div>
                <div class="form-group">
                  <label>Value:</label>
                  <input
                    type="text"
                    [(ngModel)]="group.ratedFrequency.value"
                    placeholder="Valor (opcional)"
                  />
                </div>
                <div class="form-group">
                  <label>Unit:</label>
                  <input
                    type="text"
                    [value]="'\\one'"
                    readonly
                    class="readonly-field"
                    title="Este campo no es editable"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button class="save-btn" (click)="saveBlock('objectGroups')">
            <i class="material-icons">save</i>
            Guardar Object Groups
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sub Items Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>Sub Items</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditing('subItems')"
          class="edit-btn"
          (click)="toggleEdit('subItems')"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>
        <div *ngIf="isEditing('subItems')" class="editing-actions">
          <button class="add-btn" (click)="addSubItem()">
            <i class="material-icons">add</i>
            Agregar SubItem
          </button>
          <button class="cancel-btn" (click)="cancelEdit('subItems')">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <div class="block-content">
      <!-- Vista solo lectura de subitems -->
      <div *ngIf="!isEditing('subItems')">
        <div *ngIf="hasValidSubItems(); else noSubItems">
          <div class="subitem-card" *ngFor="let subItem of getValidSubItems()">
            <h6>{{ subItem.name || "SubItem sin nombre" }}</h6>
            <table class="data-table">
              <tr *ngIf="subItem.model">
                <td class="label">Model:</td>
                <td>{{ subItem.model }}</td>
              </tr>
              <tr *ngIf="subItem.manufacturer">
                <td class="label">Manufacturer:</td>
                <td>{{ subItem.manufacturer }}</td>
              </tr>
            </table>

            <!-- Identificaciones del subitem -->
            <div *ngIf="hasValidIdentifications(subItem)">
              <strong>Identifications:</strong>
              <ul class="identifications-summary">
                <li *ngFor="let id of getValidIdentifications(subItem)">
                  <strong>{{ id.issuer }}:</strong>
                  <span *ngIf="id.name">{{ id.name }} = </span>{{ id.value }}
                </li>
              </ul>
            </div>

            <!-- Item Quantities del subitem -->
            <div *ngIf="hasValidItemQuantities(subItem)">
              <strong>Item Quantities:</strong>
              <ul class="quantities-summary">
                <li *ngFor="let qty of getValidItemQuantities(subItem)">
                  <span *ngIf="qty.name">{{ qty.name }}: </span>{{ qty.value }}
                  {{ qty.unit }}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <ng-template #noSubItems>
          <p class="no-data">No hay subitems definidos</p>
        </ng-template>
      </div>

      <!-- Formulario de edición de subitems -->
      <div *ngIf="isEditing('subItems')" class="edit-form">
        <div
          class="subitem-form"
          *ngFor="let subItem of mainItem.subItems; let subItemIndex = index"
        >
          <div class="subitem-header">
            <h6>SubItem {{ subItemIndex + 1 }}</h6>
            <button class="remove-btn" (click)="removeSubItem(subItemIndex)">
              <i class="material-icons">delete</i>
            </button>
          </div>

          <!-- Información básica del subitem -->
          <div class="subitem-basic-info">
            <div class="form-group">
              <label>Name:</label>
              <input
                type="text"
                [(ngModel)]="subItem.name"
                placeholder="Nombre del subitem"
              />
            </div>
            <div class="form-group">
              <label>Model:</label>
              <input
                type="text"
                [(ngModel)]="subItem.model"
                placeholder="Modelo"
              />
            </div>
            <div class="form-group">
              <label>Manufacturer:</label>
              <input
                type="text"
                [(ngModel)]="subItem.manufacturer"
                placeholder="Fabricante"
              />
            </div>
          </div>

          <!-- Identificaciones del subitem con opciones predefinidas -->
          <div class="subitem-identifications">
            <div class="identifications-header">
              <h6>Identifications & Item Quantities</h6>
              <button
                class="add-btn-small"
                (click)="addSubItemIdentification(subItemIndex)"
              >
                <i class="material-icons">add</i>
                Add Field
              </button>
            </div>

            <div class="identifications-list">
              <!-- Mostrar identificaciones regulares -->
              <div
                class="identification-item-enhanced"
                *ngFor="
                  let identification of subItem.identifications;
                  let idIndex = index
                "
              >
                <div class="identification-row">
                  <div class="form-group identification-type">
                    <label>Type:</label>
                    <select
                      [(ngModel)]="identification.selectedOption"
                      (ngModelChange)="
                        onIdentificationOptionChange(
                          subItemIndex,
                          idIndex,
                          $event
                        )
                      "
                      class="identification-select"
                    >
                      <option
                        *ngFor="let option of identificationOptions"
                        [ngValue]="option"
                      >
                        {{ option.displayText }}
                      </option>
                    </select>
                  </div>

                  <div class="form-group identification-value">
                    <label>Value:</label>
                    <input
                      type="text"
                      [(ngModel)]="identification.value"
                      placeholder="Enter value"
                      class="identification-input"
                    />
                  </div>

                  <div class="form-group identification-actions">
                    <button
                      class="remove-btn-small"
                      (click)="
                        removeSubItemIdentification(subItemIndex, idIndex)
                      "
                      title="Remove field"
                    >
                      <i class="material-icons">delete</i>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Mostrar item quantities que tienen selectedOption (vienen del formulario) -->
              <div
                class="identification-item-enhanced quantity-item"
                *ngFor="
                  let quantity of subItem.itemQuantities;
                  let qtyIndex = index
                "
                [ngClass]="{ 'form-quantity': quantity.selectedOption }"
              >
                <ng-container *ngIf="quantity.selectedOption">
                  <div class="identification-row">
                    <div class="form-group identification-type">
                      <label>Type:</label>
                      <select
                        [(ngModel)]="quantity.selectedOption"
                        class="identification-select"
                        disabled
                      >
                        <option [ngValue]="quantity.selectedOption">
                          {{ quantity.selectedOption.displayText }}
                        </option>
                      </select>
                    </div>

                    <div class="form-group identification-value">
                      <label>Value:</label>
                      <input
                        type="text"
                        [(ngModel)]="quantity.value"
                        placeholder="Enter value"
                        class="identification-input"
                      />
                    </div>

                    <div class="form-group identification-actions">
                      <button
                        class="remove-btn-small"
                        (click)="removeSubItemQuantity(subItemIndex, qtyIndex)"
                        title="Remove field"
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button class="save-btn" (click)="saveBlock('subItems')">
            <i class="material-icons">save</i>
            Guardar Sub Items
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
