<div class="items-container">
  <div class="section-header">
    <h3>Items</h3>
    <p>Gestión de equipos e identificaciones de objetos</p>
  </div>

  <!-- Main Item -->
  <div class="data-block">
    <div class="block-header">
      <h4>Main Item</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditingMainItem"
          class="edit-btn"
          (click)="toggleEditMainItem()"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>

        <ng-container *ngIf="isEditingMainItem">
          <button class="save-btn" (click)="saveMainItem()">
            <i class="material-icons">save</i>
            Guardar
          </button>
          <button class="cancel-btn" (click)="cancelMainItemEdit()">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </ng-container>
      </div>
    </div>

    <div class="block-content">
      <!-- View Mode -->
      <div
        *ngIf="!isEditingMainItem && items.length > 0"
        class="main-item-view"
      >
        <table class="data-table">
          <tr>
            <td class="label">Object Name:</td>
            <td>{{ items[0].name || "No definido" }}</td>
          </tr>
          <tr>
            <td class="label">Manufacturer:</td>
            <td>{{ items[0].manufacturer || "No definido" }}</td>
          </tr>
          <tr>
            <td class="label">Model:</td>
            <td>{{ items[0].model || "No definido" }}</td>
          </tr>
          <tr>
            <td class="label">Serial Number:</td>
            <td>{{ items[0].serialNumber || "No definido" }}</td>
          </tr>
          <tr>
            <td class="label">Customer Asset ID:</td>
            <td>{{ items[0].customerAssetId || "No definido" }}</td>
          </tr>
        </table>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditingMainItem && items.length > 0" class="main-item-edit">
        <div class="edit-form">
          <div class="main-item-grid">
            <div class="form-group">
              <label>Object Name:</label>
              <input
                type="text"
                [(ngModel)]="items[0].name"
                placeholder="Ingrese el nombre del objeto"
              />
            </div>

            <div class="form-group">
              <label>Manufacturer:</label>
              <input
                type="text"
                [(ngModel)]="items[0].manufacturer"
                placeholder="Ingrese el fabricante"
              />
            </div>

            <div class="form-group">
              <label>Model:</label>
              <input
                type="text"
                [(ngModel)]="items[0].model"
                placeholder="Ingrese el modelo"
              />
            </div>

            <div class="form-group">
              <label>Serial Number:</label>
              <input
                type="text"
                [(ngModel)]="items[0].serialNumber"
                placeholder="Ingrese el número de serie"
              />
            </div>

            <div class="form-group">
              <label>Customer Asset ID:</label>
              <input
                type="text"
                [(ngModel)]="items[0].customerAssetId"
                placeholder="Ingrese el ID del activo del cliente"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!items.length" class="empty-state">
        <div class="empty-content">
          <i class="material-icons">inventory_2</i>
          <h4>No hay items disponibles</h4>
          <p>
            Los datos del main item se cargarán automáticamente cuando se cree o
            cargue un DCC.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Sub Items -->
  <div class="data-block">
    <div class="block-header">
      <h4>Sub Items</h4>
      <div class="block-actions">
        <button
          *ngIf="!isEditing('subitems')"
          class="edit-btn"
          (click)="toggleEdit('subitems')"
        >
          <i class="material-icons">edit</i>
          Editar
        </button>

        <ng-container *ngIf="isEditing('subitems')">
          <button class="add-btn" (click)="addSubItem()">
            <i class="material-icons">add</i>
            Agregar SubItem
          </button>
          <button class="save-btn" (click)="saveBlock('subitems')">
            <i class="material-icons">save</i>
            Guardar
          </button>
          <button class="cancel-btn" (click)="cancelEdit('subitems')">
            <i class="material-icons">close</i>
            Cancelar
          </button>
        </ng-container>
      </div>
    </div>

    <div class="block-content">
      <!-- View Mode -->
      <div
        *ngIf="!isEditing('subitems') && mainItem.subItems?.length > 0"
        class="subitems-view"
      >
        <div
          *ngFor="let subItem of mainItem.subItems; let i = index"
          class="subitem-card"
        >
          <h6>{{ subItem.name || "SubItem " + (i + 1) }}</h6>
          <table class="data-table">
            <tr>
              <td class="label">Name:</td>
              <td>{{ subItem.name || "No definido" }}</td>
            </tr>
            <tr>
              <td class="label">Manufacturer:</td>
              <td>{{ subItem.manufacturer || "No definido" }}</td>
            </tr>
            <tr>
              <td class="label">Model:</td>
              <td>{{ subItem.model || "No definido" }}</td>
            </tr>
          </table>

          <!-- Identifiers (nueva estructura dinámica) -->
          <div *ngIf="subItem.identifiers?.length > 0">
            <h7>Identifiers</h7>
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let id of subItem.identifiers">
                  <td>{{ id.name }}</td>
                  <td>{{ id.value }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit Mode -->
      <div *ngIf="isEditing('subitems')" class="subitems-edit">
        <div
          *ngFor="let subItem of mainItem.subItems; let i = index"
          class="subitem-form"
          [class.marked-for-deletion]="subItem._markedForDeletion"
        >
          <div class="subitem-header">
            <h6>
              SubItem {{ i + 1 }}
              <span *ngIf="subItem._markedForDeletion" class="deletion-badge">
                <i class="material-icons">delete_forever</i>
                Marcado para eliminación
              </span>
            </h6>
            <button
              class="remove-btn"
              (click)="removeSubItem(i)"
              [disabled]="subItem._markedForDeletion"
            >
              <i class="material-icons">delete</i>
            </button>
          </div>

          <!-- Resto del contenido deshabilitado si está marcado para eliminación -->
          <div [class.disabled-content]="subItem._markedForDeletion">
            <!-- Basic Info -->
            <div class="subitem-basic-info">
              <div class="form-group">
                <label>Name:</label>
                <input
                  type="text"
                  [(ngModel)]="subItem.name"
                  placeholder="Nombre del subitem"
                  [disabled]="subItem._markedForDeletion"
                />
              </div>
              <div class="form-group">
                <label>Manufacturer:</label>
                <input
                  type="text"
                  [(ngModel)]="subItem.manufacturer"
                  placeholder="Fabricante"
                  [disabled]="subItem._markedForDeletion"
                />
              </div>
              <div class="form-group">
                <label>Model:</label>
                <input
                  type="text"
                  [(ngModel)]="subItem.model"
                  placeholder="Modelo"
                  [disabled]="subItem._markedForDeletion"
                />
              </div>
            </div>

            <!-- Identifiers (nueva estructura dinámica) -->
            <div class="subitem-identifications">
              <div class="identifications-header">
                <h6>Identifiers</h6>
                <button
                  class="add-btn-small"
                  (click)="addIdentifier(i)"
                  type="button"
                  [disabled]="subItem._markedForDeletion"
                >
                  <i class="material-icons">add</i>
                  Agregar Identificador
                </button>
              </div>

              <!-- Current Identifiers -->
              <div class="current-identifiers">
                <div
                  *ngFor="
                    let identifier of subItem.identifiers;
                    let j = index;
                    trackBy: trackByIndex
                  "
                  class="identification-item-enhanced"
                  [class.marked-for-deletion]="identifier._markedForDeletion"
                >
                  <div
                    class="identification-row"
                    *ngIf="!identifier._markedForDeletion"
                  >
                    <div class="identification-type">
                      <input
                        type="text"
                        [(ngModel)]="identifier.name"
                        placeholder="Nombre del identificador"
                        class="identification-input"
                        [disabled]="subItem._markedForDeletion"
                      />
                    </div>

                    <div class="identification-value">
                      <input
                        type="text"
                        [(ngModel)]="identifier.value"
                        placeholder="Valor"
                        class="identification-input"
                        [disabled]="subItem._markedForDeletion"
                      />
                    </div>

                    <div class="identification-actions">
                      <button
                        class="remove-btn-small"
                        (click)="removeIdentifier(i, j)"
                        type="button"
                        title="Eliminar identificador"
                        [disabled]="subItem._markedForDeletion"
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Estado vacío -->
                <div
                  *ngIf="!subItem.identifiers?.length"
                  class="empty-identifiers"
                >
                  <p>
                    No hay identificadores agregados. Haga clic en "Agregar
                    Identificador" para comenzar.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button class="save-btn" (click)="saveBlock('subitems')">
            Guardar
          </button>
          <button class="cancel-btn" (click)="cancelEdit('subitems')">
            Cancelar
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!mainItem.subItems?.length" class="empty-state">
        <div class="empty-content">
          <i class="material-icons">devices</i>
          <h4>No hay sub items</h4>
          <p>
            Haga clic en "Editar" para agregar sub items al equipo principal.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
