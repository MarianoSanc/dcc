<div class="items-container">
  <div class="section-header">
    <h3>Items</h3>
    <p>Elementos y equipos incluidos en el certificado de calibración</p>
  </div>

  <!-- Object Block -->
  <div class="data-block">
    <div class="block-header">
      <h4>IDENTIFICATION OF THE CALIBRAND (DUT)</h4>
    </div>

    <div class="block-content">
      <div class="object-value">
        <strong>Object:</strong> {{ objectData.value }}
      </div>

      <!-- Object Identifications Sub-block -->
      <div class="sub-block">
        <div class="sub-block-header">
          <h5>Identifications</h5>
          <div class="block-actions">
            <button class="add-btn" (click)="addObjectIdentification()">
              <i class="material-icons">add</i>
              Agregar
            </button>
            <button
              class="edit-btn"
              (click)="toggleEdit('object-identifications')"
              [class.active]="isEditing('object-identifications')"
            >
              <i class="material-icons">{{
                isEditing("object-identifications") ? "close" : "edit"
              }}</i>
              {{ isEditing("object-identifications") ? "Cancelar" : "Editar" }}
            </button>
          </div>
        </div>

        <!-- View Mode -->
        <div
          *ngIf="!isEditing('object-identifications')"
          class="identifications-view"
        >
          <div
            *ngFor="let group of getGroupedObjectIdentifications() | keyvalue"
            class="group-view"
          >
            <div class="group-title">
              <h6>{{ group.key }}</h6>
            </div>
            <table class="data-table group-table">
              <thead>
                <tr>
                  <th>Value</th>
                  <th>Name</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of group.value">
                  <td>{{ item.value || "No especificado" }}</td>
                  <td>{{ item.name || "No especificado" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Edit Mode -->
        <div
          *ngIf="isEditing('object-identifications')"
          class="object-identifications-edit"
        >
          <div class="edit-form">
            <div
              class="identification-group"
              *ngFor="
                let group of objectIdentificationGroups;
                let groupIndex = index
              "
            >
              <div class="group-header">
                <div class="group-name-edit">
                  <label>Nombre del Grupo:</label>
                  <input
                    type="text"
                    [value]="
                      group[0]?.groupName || getDefaultGroupName(groupIndex)
                    "
                    (blur)="updateGroupName(groupIndex, $event.target.value)"
                    placeholder="Nombre del grupo"
                    class="group-name-input"
                  />
                </div>
                <button
                  class="remove-group-btn"
                  (click)="removeObjectIdentificationGroup(groupIndex)"
                  [disabled]="objectIdentificationGroups.length <= 1"
                >
                  <i class="material-icons">delete</i>
                  Eliminar Grupo
                </button>
              </div>

              <div
                class="identification-form"
                *ngFor="let id of group; let idIndex = index"
              >
                <div class="form-grid">
                  <div class="form-group">
                    <label>Name:</label>
                    <input
                      type="text"
                      [value]="id.name"
                      readonly
                      class="readonly-input"
                      placeholder="Nombre predefinido (Solo lectura)"
                    />
                  </div>
                  <div class="form-group">
                    <label>Value:</label>
                    <input
                      type="text"
                      [(ngModel)]="id.value"
                      placeholder="Ingrese el valor"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="form-actions">
              <button
                class="save-btn"
                (click)="saveBlock('object-identifications')"
              >
                Guardar
              </button>
              <button
                class="cancel-btn"
                (click)="cancelEdit('object-identifications')"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Item Button -->
  <div class="add-item-section">
    <button class="add-item-btn" (click)="addItem()">
      <i class="material-icons">add</i>
      Agregar Item
    </button>
  </div>

  <!-- Items List -->
  <div class="items-list" *ngIf="items.length > 0">
    <div class="item-card" *ngFor="let item of items; let itemIndex = index">
      <!-- Item Block -->
      <div class="data-block">
        <div class="block-header">
          <h4>Item {{ itemIndex + 1 }}: {{ item.name || "Sin nombre" }}</h4>
          <div class="item-actions">
            <button
              class="edit-btn"
              (click)="editItem(item.id)"
              *ngIf="!isEditingItem(item.id)"
            >
              <i class="material-icons">edit</i>
              Editar
            </button>
            <button
              class="save-btn"
              (click)="saveItem(item.id)"
              *ngIf="isEditingItem(item.id)"
            >
              <i class="material-icons">save</i>
              Guardar
            </button>
            <button
              class="cancel-btn"
              (click)="cancelEditItem(item.id)"
              *ngIf="isEditingItem(item.id)"
            >
              <i class="material-icons">close</i>
              Cancelar
            </button>
            <button class="remove-btn" (click)="removeItem(item.id)">
              <i class="material-icons">delete</i>
              Eliminar
            </button>
          </div>
        </div>

        <div class="block-content">
          <!-- View Mode -->
          <div *ngIf="!isEditingItem(item.id)" class="item-view">
            <div class="item-info">
              <table class="data-table">
                <tr>
                  <td class="label">Name/Description:</td>
                  <td>{{ item.name || "No especificado" }}</td>
                </tr>
                <tr>
                  <td class="label">Model:</td>
                  <td>{{ item.model || "No especificado" }}</td>
                </tr>
                <tr>
                  <td class="label">Manufacturer:</td>
                  <td>{{ item.manufacturer || "No especificado" }}</td>
                </tr>
              </table>
            </div>

            <!-- Item Identifications Sub-block -->
            <div class="sub-block">
              <div class="sub-block-header">
                <h5>Identifications</h5>
              </div>
              <div class="identifications-view">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Issuer</th>
                      <th>Value</th>
                      <th>Name</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let identification of item.identifications">
                      <td>{{ identification.issuer || "No especificado" }}</td>
                      <td>{{ identification.value || "No especificado" }}</td>
                      <td>{{ identification.name || "No especificado" }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Edit Mode -->
          <div *ngIf="isEditingItem(item.id)" class="item-edit">
            <div class="edit-form">
              <div class="form-group">
                <label>Name/Description:</label>
                <input
                  type="text"
                  [(ngModel)]="item.name"
                  placeholder="Ingrese el nombre o descripción del item"
                  required
                />
              </div>
              <div class="form-group">
                <label>Model:</label>
                <input
                  type="text"
                  [(ngModel)]="item.model"
                  placeholder="Ingrese el modelo"
                />
              </div>
              <div class="form-group">
                <label>Manufacturer:</label>
                <input
                  type="text"
                  [(ngModel)]="item.manufacturer"
                  placeholder="Ingrese el fabricante"
                />
              </div>
            </div>

            <!-- Item Identifications Sub-block Edit -->
            <div class="sub-block">
              <div class="sub-block-header">
                <h5>Identifications</h5>
                <div class="block-actions">
                  <button
                    class="add-btn"
                    (click)="addItemIdentification(itemIndex)"
                  >
                    <i class="material-icons">add</i>
                    Agregar
                  </button>
                </div>
              </div>
              <div class="identifications-edit">
                <div class="edit-form">
                  <div
                    class="identification-item"
                    *ngFor="
                      let identification of item.identifications;
                      let i = index
                    "
                  >
                    <div class="form-group">
                      <label>Issuer:</label>
                      <select [(ngModel)]="identification.issuer">
                        <option value="">Seleccione el emisor</option>
                        <option value="Manufacturer">Manufacturer</option>
                        <option value="Calibration Laboratory">
                          Calibration Laboratory
                        </option>
                        <option value="Customer">Customer</option>
                        <option value="Owner">Owner</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Value:</label>
                      <input type="text" [(ngModel)]="identification.value" />
                    </div>
                    <div class="form-group">
                      <label>Name:</label>
                      <input type="text" [(ngModel)]="identification.name" />
                    </div>
                    <div class="form-group delete-action">
                      <button
                        class="remove-btn"
                        (click)="removeItemIdentification(itemIndex, i)"
                      >
                        <i class="material-icons">delete</i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="empty-state" *ngIf="items.length === 0">
    <div class="empty-content">
      <i class="material-icons">inventory_2</i>
      <h4>No hay items agregados</h4>
      <p>
        Haz clic en "Agregar Item" para comenzar a añadir elementos al
        certificado.
      </p>
    </div>
  </div>
</div>
